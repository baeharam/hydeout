---
layout: post
category: flutter
title: "[Flutter]Firebase의 Database 사용하기"
---

Firebase는 상당히 많은 서비스를 제공하는데 플러터도 공식적으로 지원하는 플러그인을 통해 해당 서비스들을 사용할 수 있다. 그 중 Database 서비스를 사용해보자. 먼저 [firebase_database](https://pub.dartlang.org/packages/firebase_database) 패키지를 설치해야 Firebase와 연동할 수 있고, 여러가지 설정들을 거쳐야 하는데 Firebase 홈페이지나 유튜브에 자세히 나와있으니 설치는 그쪽을 참고하도록 하자.

# Database의 인스턴스 가져오기

먼저, Database를 사용하기 위해선 인스턴스를 가져와야 하며 3가지 단계로 구성된다.

```dart
import 'package:firebase_database/firebase_database.dart';

final FirebaseDatabase database = FirebaseDatabase.instance;
DatabaseReference databaseReference = database.reference().child("경로");
```

설명하려고 했으나 정식 코드의 주석을 보는 것이 더 나을 것 같다. 먼저 `FirebaseDatabase.instance`이다.

> Gets the instance of FirebaseDatabase for the default Firebase app.

Firebase 앱의 FirebaseDatabase 인스턴스를 가져온다고 한다. 그 다음 `reference()`를 보자.

> Gets a DatabaseReference for the root of your Firebase Database.

FirebaseDatabase의 루트경로에 대한 DatabaseReference를 가져온다. 그럼 `child`는?

> Gets a DatabaseReference for the location at the specified relative path. The relative path can either be a simple child key (e.g. ‘fred’) or a deeper slash-separated path (e.g. ‘fred/name/first’).

그냥 key 값일수도 있고 좀 깊은 상대 경로일 수도 있는데 루트가 아닌 그 안쪽 경로의 DatabaseReference를 가져온다는 것이다. 여기선 가독성을 좋게 하려고 저렇게 썼지만 실제로 사용할 때는 다음과 같이 사용해야 한다.

```dart
// 위쪽에 DatabaseReference databaseReference; 있음
@override
void initState() {
    super.initState();
    databaseReference = database.reference().child("경로");
}
```

이게 실제적인 이유는 지금 찾아보고 있는데 Database의 객체를 생성할 때 static인데 reference 메소드는 인스턴스 메소드라서 그런 것 같긴 하다. 하지만 Database의 객체를 생성할 때 static을 써주었는데도 소용이 없는 걸 보면 정확한 영문은 모르겠다. 방금 깨달았는데.. initState가 인스턴스 메소드라서 static 변수를 써도 상관이 없는 것이었다. 또 객체 생성할 때 static은 아무 상관이 없는 거다....ㅠ. 증거로 build 메소드는 인스턴스 메소드이기 때문에 static 변수의 인스턴스메소드를 사용할 수 있다.

<br>

# Database에 데이터 저장하기

```dart
@override
void initState() {
    super.initState();
    databaseReference = database.reference().child("haram");
    databaseReference.push().set({
	    "파이어베이스": "굿굿",
	    "진짜로?": "ㅇㅇ"
    });
}
```

위 코드에 이어서 데이터를 저장해보자. 저장하는 방법은 많은 방법이 있지만 push()메소드를 사용할 수 있다. 이것도 정식 코드의 주석을 보도록 하자.

> Generates a new child location using a unique key and returns a DatabaseReference to it. **This is useful when the children of a Firebase Database location represent a list of items.** The unique key generated by childByAutoId: is prefixed with a client-generated timestamp so that the resulting list will be chronologically-sorted.

새로운 child location을 생성해내는데 unique key로 생성을 하고 그에 대한 DatabaseReference 객체를 리턴한다. 따라서 거기에 set() 메소드를 사용해서 데이터를 저장할 수 있다. 여기선 어떤 값들을 저장할 수 있는지만 보자.

> Data types that are allowed are String, boolean, int, double, Map, List.

위의 허용되는 타입들 중에 Map 데이터를 위 코드처럼 넣어본 결과이다.

<img src="https://user-images.githubusercontent.com/35518072/42674902-88f3c9d8-86ac-11e8-80e4-9f86022b1276.png">

<br>

# Database에서 데이터 가져오기

데이터를 가져오기 위해선 일단 내가 알아낸 방법으로는 onChildAdded() 메소드를 사용해서 추가할 때 바로 가져오거나, 아니면 추가할 때마다 List에 저장해서 나중에 가져오는 것이다. 나중에 알게되면 더 추가하자. 위 코드에서 저장한 데이터를 가져와 콘솔에 출력해보자.

```dart
@override
void initState() {
    super.initState();
    databaseReference = database.reference().child("haram");
    databaseReference.push().set({
	    "파이어베이스": "굿굿",
	    "진짜로?": "ㅇㅇ"
    });
    databaseReference.onChildAdded((e){
        print(e.snapshot.key);
        print(e.snapshot.value);
    });
}
```

> Performing hot restart...
> Restarted app in 1,342ms.
> I/flutter ( 6935): -LH3YSMyOukjMVHXc1Qo
> I/flutter ( 6935): {진짜로?: ㅇㅇ, 파이어베이스: 굿굿}

결과는 위와 같이 나오는데 봐야 할 것은 snapshot이라는 변수이다. Event 클래스의 인스턴스 변수로 DataSnapshot 타입이다. 그럼 Event와 DataSnapshot에 대해 알아봐야 한다. Event는 다음과 같이 정의된다.

> "Event" encapsulates a DataSnapshot and possibly also the key of its previous sibling, which can be used to order the snapshots.

DataSnapshot을 캡슐화 한 것이고 이제 DataSnapshot을 보면,

> A DataSnapshot contains data from a Firebase Database location. Any time you read Firebase data, you receive the data as a DataSnapshot.

Firebase Database에서 오는 데이터를 포함하는 클래스임을 알 수 있다. 따라서 onChildAdded 메소드가 하는 역할은 Event 객체를 받아 해당 DataSnapshot객체의 값들에 접근하여 처리하는 것이다.